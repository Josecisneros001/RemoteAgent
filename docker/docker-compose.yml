services:
  remote-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    ports:
      - "3000:3000"
    volumes:
      # Workspace directory - AI can only access this folder
      - ~/your/projects/folder:/workspace

      # Allowlist configuration (hot-reload enabled)
      - ./allowlist.json:/app/allowlist.json

      # Claude CLI auth and config (for agent user)
      - ~/.claude.json:/home/agent/.claude.json
      - ~/.claude-docker/:/home/agent/.claude/
      # Mount host's settings.json to staging location (entrypoint copies & modifies for Docker)
      - ~/.claude/settings.json:/tmp/claude-settings.json:ro

      # Copilot CLI auth and config (for agent user)
      - ~/.copilot-docker:/home/agent/.copilot
      - ~/.config/github-copilot:/home/agent/.config/github-copilot

      # DNS logs (optional - mount to see logs on host)
      - ./logs:/var/log/dns

      # RemoteAgent data (sessions, runs, config)
      - ~/.remote-agent-docker:/home/agent/.remote-agent
    environment:
      - NODE_ENV=production
      - DOCKER_MODE=true
      - WORKSPACE_PATH=/workspace
      # Set to false to disable DNS-based network filtering
      - ENABLE_NETWORK_FILTER=true
      # Increase Node.js heap size for Claude CLI (prevents OOM on large sessions)
      - NODE_OPTIONS=--max-old-space-size=8192
    cap_add:
      # Required for iptables firewall rules
      - NET_ADMIN
    extra_hosts:
      # Allow container to access host machine services (e.g., local API on port 4000)
      - "host.docker.internal:host-gateway"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    deploy:
      resources:
        limits:
          cpus: '16.0'
          memory: 12800M
        reservations:
          cpus: '2.0'
          memory: 2G
    restart: unless-stopped
